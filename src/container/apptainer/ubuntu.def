# Specify that we are using a Docker image as the base
Bootstrap: docker

# Use the latest Ubuntu LTS image
From: ubuntu:latest

# Section to install packages after the base image is loaded
%post
    # Update package list 
    apt-get update

    # install necessary OS packages
    apt-get install -y nano vim git curl wget
    apt -qy install libssl-dev libffi-dev  make cmake gcc
    apt -qy install zlib1g-dev libbz2-dev libreadline-dev libsqlite3-dev
   
    # install firedrake dependencies
    apt -qy install autoconf automake bison flex gfortran pkg-config libcurl4-openssl-dev
    apt -qy install pkgconf libtool libxml2-dev ninja-build python3-dev python3-pip python3-tk
    apt -qy install python3-venv libboost-dev libopenblas-dev
 
    #Download and install minconda
    apt -qy install  build-essential  libncurses5-dev libgdbm-dev libnss3-dev
    mkdir -p ~/miniconda3
    wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O ~/miniconda3/miniconda.sh
    bash ~/miniconda3/miniconda.sh -b -u -p ~/miniconda3
    rm ~/miniconda3/miniconda.sh 
    
    # activate miniconda env
    . ~/miniconda3/bin/activate
    pip install siphash24
    pip install pyyaml

    # Download the firedrake install script
    curl -O https://raw.githubusercontent.com/firedrakeproject/firedrake/master/scripts/firedrake-install

    # install firedrake by running the script
    python3 firedrake-install

    # Activate the Firedrake virtual environment 
    # . firedrake/bin/activate

    # Install icepack
    # pip install git+https://github.com/icepack/Trilinos.git
    # pip install git+https://github.com/icepack/pyrol.git
    # git clone https://github.com/icepack/icepack.git
    # pip install ./icepack

    # # Run a test
    # pytest -s icepack/test/ice_shelf_test.py

    # # add virtaul environments
    # pip install ipykernel
    # python3 -m ipykernel install --user --name=firedrake

    # #install gmsh
    # apt-get -qy install gmsh

%environment
    export HDF5_MPI=ON
    export OMP_NUM_THREADS=1
    export OPENBLAS_NUM_THREADS=1

%runscript
    #!/bin/bash
    # commands to execute when the container is lauched
    # . /firedrake/bin/activate #activate the firedrake env
    python3 "$@"
    exec /bin/bash

%labels
    Author Brian Kyanjo
    ContactEmail bkyanjo3@gatech.edu
    Name Firedrake-icepack cointainer

%help
    This Apptainer container ubuntu-based definition configures 
    and installs the necessary dependencies of firedrake and icepack 
    plus activating there environments. To use this container, just 
    run: 1. $ apptainer build icepack.sif ubuntu.def #this creates .sif image
         2. $ apptainer shell icepack.sif # this starts the apptainer shell
         3. $ apptainer exec  icepack.sif script.py
    
    
